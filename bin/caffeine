#!/bin/bash

CAFFEINE="$HOME/.caffeine"
CAFFEINE_PATCHES="$HOME/.coffee/patches/caffeine"
SOURCE_DIR="/usr/bitey/software/caffeine"

patch_coffee() {
    if [[ -d "$CAFFEINE_PATCHES" ]]; then
        rm -rf -- "$CAFFEINE_PATCHES"
    fi

    echo "üîÑ Patching Coffee..."

    mkdir -p -- "$CAFFEINE_PATCHES"

    if [[ -d "$CAFFEINE/patches" ]]; then
        cp -r -- "$CAFFEINE/patches/"* "$CAFFEINE_PATCHES/"
        echo "‚úÖ Patched Coffee!"
    else
        echo "‚ùå Patch source directory not found: $CAFFEINE/patches"
    fi
}

if [[ ! -d "$CAFFEINE" ]]; then
  echo "üîÑ Setting up Caffeine..."
  cp -r /usr/bitey/software/caffeine $HOME/.caffeine
  if [[ ! -d "$CAFFEINE_PATCHES" ]]; then
      patch_coffee
  fi
  echo "‚úÖ Caffeine installed!"
fi

if [[ ! -d "$CAFFEINE_PATCHES" ]]; then
    patch_coffee
fi

# Load version info
if [[ -f "$CAFFEINE/pak.conf" ]]; then
  source "$CAFFEINE/pak.conf"
  cat "$CAFFEINE/caffeine.txt"
  echo
  echo "ü§é Caffeine $PACKAGE_VERSION"
else
  echo "‚ùå pak.conf not found in $CAFFEINE."
  exit 1
fi

if [[ "$1" == "plugin" && "$2" == "update" ]]; then
  echo "üîÑ Updating all Caffeine plugins..."

  for plugin_dir in "$CAFFEINE/plugins/"*; do
    if [[ -d "$plugin_dir/.git" ]]; then
      echo "üîß Updating plugin: $(basename "$plugin_dir")"
      git -C "$plugin_dir" reset --hard HEAD
      git -C "$plugin_dir" pull --quiet
      if [[ -f "$plugin_dir/scripts/update.sh" ]]; then
          bash "$plugin_dir/scripts/update.sh"
      fi
      chmod +x "$plugin_dir/bin/"
    else
      echo "‚ö†Ô∏è Skipping $(basename "$plugin_dir") (not a Git repo)"
    fi
  done

  echo "‚úÖ Plugin update complete."
  exit 0
fi

if [[ "$1" == "plugin" ]]; then
    PLUGIN="$3"
    PLUGIN_DIR="$CAFFEINE/plugins/$PLUGIN"
    if [[ "$2" == "install" ]]; then
        if [[ -z "$PLUGIN" ]]; then
            echo "‚ùå Please specify a plugin name."
            exit 1
        fi

        if [[ -d "$PLUGIN_DIR" ]]; then
            echo "‚ö†Ô∏è Plugin $PLUGIN is already installed at $PLUGIN_DIR."
            exit 1
        fi

        echo "üì¶ Installing plugin $PLUGIN..."
        if ! git clone "https://github.com/CaffeineGallery/$PLUGIN" "$PLUGIN_DIR"; then
            echo "‚ùå Failed to install $PLUGIN."
            exit 1
        fi

        INSTALL_SCRIPT="$PLUGIN_DIR/scripts/install.sh"
        if [[ -f "$INSTALL_SCRIPT" ]]; then
            bash "$INSTALL_SCRIPT"
        else
            echo "‚ö†Ô∏è No install script found for $PLUGIN. Skipping install step."
        fi

        echo "‚úÖ Installed plugin $PLUGIN!"
        exit 0
    fi
    if [[ "$2" == "remove" ]]; then
        if [[ -z "$PLUGIN" ]]; then
            echo "‚ùå Please specify a plugin name."
            exit 1
        fi
        if [[ ! -d "$PLUGIN_DIR" ]]; then
            echo "‚ùå No such plugin $PLUGIN."
            exit 1
        fi
        if [[ -f "$PLUGIN_DIR/scripts/remove.sh" ]]; then
            bash "$PLUGIN_DIR/scripts/remove.sh"
        fi
        rm -rf "$PLUGIN_DIR"
        echo "‚úÖ Removed plugin $PLUGIN."
        exit 0
    fi
fi

if [[ "$1" == "repatch" ]]; then
    patch_coffee
fi
