#!/bin/bash

CAFFEINE="$HOME/.caffeine"
SOURCE_DIR="/usr/bitey/software/caffeine"

if [[ ! -d "$CAFFEINE" ]]; then
  echo "üîÑ Setting up Caffeine..."
  cp -r /usr/bitey/software/caffeine $HOME/.caffeine
  echo
  echo "‚úÖ Caffeine installed!"
fi

# Load version info
if [[ -f "$CAFFEINE/pak.conf" ]]; then
  source "$CAFFEINE/pak.conf"
  echo "ü§é Caffeine $PACKAGE_VERSION"
else
  echo "‚ùå pak.conf not found in $CAFFEINE."
  exit 1
fi

if [[ "$1" == "plugin" ]]; then
    PLUGIN="$3"
    PLUGIN_DIR="$CAFFEINE/plugins/$PLUGIN"
    if [[ "$2" == "install" ]]; then
        if [[ -z "$PLUGIN" ]]; then
            echo "‚ùå Please specify a plugin name."
            exit 1
        fi

        if [[ -d "$PLUGIN_DIR" ]]; then
            echo "‚ö†Ô∏è Plugin $PLUGIN is already installed at $PLUGIN_DIR."
            exit 1
        fi

        echo "üì¶ Installing plugin $PLUGIN..."
        if ! git clone "https://github.com/CaffeineGallery/$PLUGIN" "$PLUGIN_DIR"; then
            echo "‚ùå Failed to install $PLUGIN."
            exit 1
        fi

        INSTALL_SCRIPT="$PLUGIN_DIR/scripts/install.sh"
        if [[ -f "$INSTALL_SCRIPT" ]]; then
            bash "$INSTALL_SCRIPT"
        else
            echo "‚ö†Ô∏è No install script found for $PLUGIN. Skipping install step."
        fi

        echo "‚úÖ Installed plugin $PLUGIN!"
        exit 0
    fi
    if [[ "$2" == "remove" ]]; then
        if [[ ! -d "$PLUGIN_DIR" ]]; then
            echo "‚ùå No such plugin $PLUGIN."
            exit 1
        fi
        if [[ -f "$PLUGIN_DIR/scripts/remove.sh" ]]; then
            bash "$PLUGIN_DIR/scripts/remove.sh"
        fi
        rm -rf "$PLUGIN_DIR"
        echo "‚úÖ Removed plugin $PLUGIN."
        exit 0
    fi
fi
